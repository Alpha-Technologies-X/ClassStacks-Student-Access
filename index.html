<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Stacks - Student Browser</title>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --danger: #e63946;
            --success: #2a9d8f;
            --warning: #f4a261;
            --dark: #212529;
            --light: #f8f9fa;
            --tab-active: #ffffff;
            --tab-inactive: #f1f3f4;
            --tab-border: #dadce0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f5f7fb;
            color: var(--dark);
            overflow: hidden;
        }
        
        /* Authentication Styles */
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 20px;
        }
        
        .auth-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo h1 {
            color: var(--primary);
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5ee;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        .btn {
            padding: 12px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: var(--secondary);
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .error-message {
            color: var(--danger);
            text-align: center;
            margin-top: 15px;
            padding: 12px;
            background: #ffeaea;
            border-radius: 8px;
            display: none;
        }
        
        /* Student Browser Styles */
        .student-browser {
            display: none;
            height: 100vh;
            flex-direction: column;
            background: white;
        }
        
        /* Browser Header */
        .browser-header {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .student-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .student-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .student-details {
            font-size: 0.9rem;
        }
        
        .student-details strong {
            font-size: 1rem;
        }
        
        /* Tab Bar */
        .tab-bar {
            display: flex;
            background: var(--tab-inactive);
            border-bottom: 1px solid var(--tab-border);
            padding: 0 10px;
            align-items: center;
            overflow-x: auto;
        }
        
        .tab {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: var(--tab-inactive);
            border-right: 1px solid var(--tab-border);
            min-width: 200px;
            max-width: 300px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .tab.active {
            background: var(--tab-active);
            border-bottom: 2px solid var(--primary);
        }
        
        .tab-favicon {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            flex-shrink: 0;
        }
        
        .tab-title {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.9rem;
        }
        
        .tab-close {
            margin-left: 8px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        
        .tab-close:hover {
            background: rgba(0, 0, 0, 0.1);
        }
        
        .new-tab-btn {
            padding: 10px 15px;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #666;
            transition: all 0.3s;
        }
        
        .new-tab-btn:hover {
            color: var(--primary);
            background: rgba(0, 0, 0, 0.05);
        }
        
        /* Browser Controls */
        .browser-controls {
            display: flex;
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            gap: 10px;
            align-items: center;
        }
        
        .nav-buttons {
            display: flex;
            gap: 5px;
        }
        
        .nav-btn {
            padding: 8px 12px;
            background: white;
            border: 1px solid #e1e5ee;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .nav-btn:hover {
            background: #f0f0f0;
        }
        
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .url-input-container {
            flex: 1;
            display: flex;
            background: white;
            border: 2px solid #e1e5ee;
            border-radius: 25px;
            overflow: hidden;
        }
        
        .url-input {
            flex: 1;
            padding: 10px 20px;
            border: none;
            font-size: 16px;
        }
        
        .url-input:focus {
            outline: none;
        }
        
        .go-button {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .go-button:hover {
            background: var(--secondary);
        }
        
        /* Tab Content */
        .tab-content {
            flex: 1;
            display: none;
            flex-direction: column;
        }
        
        .tab-content.active {
            display: flex;
        }
        
        .browser-frame {
            width: 100%;
            height: 100%;
            border: none;
            flex: 1;
        }
        
        /* Home Screen */
        .home-screen {
            padding: 40px;
            text-align: center;
            background: white;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .welcome-message {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 30px;
        }
        
        .website-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .website-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .website-item:hover {
            background: white;
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .website-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        /* Connection Page Styles */
        .connection-container {
            display: none;
            flex-direction: column;
            height: 100vh;
            background: white;
        }
        
        .connection-header {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .connection-content {
            flex: 1;
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .connection-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: var(--primary);
        }
        
        .connection-title {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .connection-subtitle {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 30px;
            max-width: 500px;
        }
        
        .connection-code {
            font-family: monospace;
            font-size: 2.5rem;
            font-weight: bold;
            background: #f8f9fa;
            padding: 20px 40px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px dashed #e1e5ee;
            letter-spacing: 5px;
        }
        
        .connection-instructions {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
            max-width: 500px;
            text-align: left;
        }
        
        .connection-instructions h3 {
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .connection-instructions ol {
            padding-left: 20px;
        }
        
        .connection-instructions li {
            margin-bottom: 10px;
        }
        
        .connection-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        /* Blocked/Locked Messages */
        .blocked-message, .locked-message {
            display: none;
            background: #ffebee;
            color: #c62828;
            padding: 40px;
            text-align: center;
            height: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .locked-message {
            background: #e9ecef;
            color: #6c757d;
        }
        
        .message-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        /* Loading Message */
        .loading-message {
            display: none;
            padding: 40px;
            text-align: center;
            font-size: 1.2rem;
            color: #666;
            flex: 1;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .loading-icon {
            font-size: 3rem;
            margin-bottom: 20px;
        }
        
        /* Bypass Panel */
        .bypass-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: 15px;
            z-index: 1000;
            display: none;
        }
        
        .bypass-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .bypass-toggle {
            background: var(--warning);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .bypass-input {
            width: 150px;
            padding: 8px;
            border: 1px solid #e1e5ee;
            border-radius: 5px;
            margin-right: 5px;
        }
        
        .bypass-submit {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* Teacher Messages */
        .teacher-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1001;
            display: none;
            max-width: 400px;
            text-align: center;
        }
        
        .message-content {
            margin: 10px 0;
            font-size: 1.1rem;
        }
        
        .message-from {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        /* Connection Status */
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 1000;
        }
        
        /* Screenshot Overlay */
        .screenshot-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1002;
        }
        
        .screenshot-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            max-width: 500px;
        }
        
        .screenshot-canvas {
            max-width: 100%;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        
        /* Website Viewer */
        .website-viewer {
            width: 100%;
            height: 100%;
            border: none;
            flex: 1;
        }
        
        .iframe-fallback {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            padding: 40px;
            text-align: center;
        }
        
        .fallback-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        
        /* Class Status Indicator */
        .class-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status-active {
            background: #e7f7e9;
            color: var(--success);
        }
        
        .status-inactive {
            background: #f0f0f0;
            color: #666;
        }
        
        /* Whiteboard Styles */
        .whiteboard-container {
            display: none;
            flex-direction: column;
            height: 100vh;
            background: white;
        }
        
        .whiteboard-header {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .whiteboard-controls {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e1e5ee;
        }
        
        .whiteboard-tool {
            padding: 8px 15px;
            border: 1px solid #e1e5ee;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .whiteboard-tool.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .whiteboard-canvas-container {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        .whiteboard-canvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }
        
        .whiteboard-users {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .user-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }
        
        .user-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        /* Settings Styles */
        .settings-container {
            display: none;
            flex-direction: column;
            height: 100vh;
            background: white;
        }
        
        .settings-header {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .settings-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .settings-section {
            margin-bottom: 30px;
        }
        
        .settings-section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e1e5ee;
        }
        
        .theme-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .theme-option {
            padding: 15px;
            border: 2px solid #e1e5ee;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .theme-option:hover {
            border-color: var(--primary);
        }
        
        .theme-option.active {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.1);
        }
        
        .theme-preview {
            width: 100%;
            height: 60px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        /* Addons Styles */
        .addons-container {
            display: none;
            flex-direction: column;
            height: 100vh;
            background: white;
        }
        
        .addons-header {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .addons-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .addons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .addon-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 20px;
            border: 1px solid #e1e5ee;
            transition: all 0.3s;
        }
        
        .addon-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        
        .addon-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .addon-icon {
            font-size: 1.5rem;
        }
        
        .addon-title {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .addon-description {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 15px;
        }
        
        .addon-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <!-- Student Authentication -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="logo">
                <h1>üéì Class Stacks</h1>
                <p>Student Browser</p>
            </div>
            
            <form id="authForm">
                <div class="form-group">
                    <label for="firstName">First Name</label>
                    <input type="text" id="firstName" placeholder="Enter your first name" required>
                </div>
                
                <div class="form-group">
                    <label for="lastName">Last Name</label>
                    <input type="text" id="lastName" placeholder="Enter your last name" required>
                </div>
                
                <div class="form-group">
                    <label for="schoolCode">School Code</label>
                    <input type="text" id="schoolCode" placeholder="Enter your school code" required>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                        Ask your teacher for the school code
                    </div>
                </div>
                
                <button type="submit" class="btn" style="width: 100%;">Enter Browser</button>
            </form>
            
            <div class="error-message" id="errorMessage"></div>
            
            <div style="margin-top: 25px; padding: 20px; background: #f8f9fa; border-radius: 10px; font-size: 14px;">
                <strong>How to Connect:</strong><br>
                1. Enter your first and last name<br>
                2. Enter your school code<br>
                3. Click "Enter Browser" to start browsing<br>
                4. Visit <strong>browser://connect</strong> to connect to a class
            </div>
        </div>
    </div>

    <!-- Student Browser -->
    <div class="student-browser" id="studentBrowser">
        <!-- Browser Header -->
        <div class="browser-header">
            <div class="student-info">
                <div class="student-avatar" id="studentAvatar">S</div>
                <div class="student-details">
                    <strong id="studentNameDisplay">Student Name</strong><br>
                    School: <span id="schoolCodeDisplay">School Code</span>
                    <span class="class-status status-inactive" id="classStatus">No Active Class</span>
                </div>
            </div>
            <div>
                <button class="btn btn-danger" onclick="logout()" style="padding: 8px 15px;">Exit Browser</button>
            </div>
        </div>
        
        <!-- Tab Bar -->
        <div class="tab-bar" id="tabBar">
            <!-- Tabs will be dynamically added here -->
            <button class="new-tab-btn" onclick="createNewTab()" title="New Tab">+</button>
        </div>
        
        <!-- Browser Controls -->
        <div class="browser-controls">
            <div class="nav-buttons">
                <button class="nav-btn" onclick="goBack()" title="Back">‚Üê</button>
                <button class="nav-btn" onclick="goForward()" title="Forward">‚Üí</button>
                <button class="nav-btn" onclick="reloadTab()" title="Reload">‚Üª</button>
                <button class="nav-btn" onclick="goHome()" title="Home">üè†</button>
            </div>
            
            <div class="url-input-container">
                <input type="text" class="url-input" id="browserUrl" placeholder="Type a URL or search...">
                <button class="go-button" onclick="navigateCurrentTab()">Go</button>
            </div>
        </div>
        
        <!-- Tab Content Area -->
        <div id="tabContentArea">
            <!-- Tab content will be dynamically added here -->
        </div>
        
        <!-- Home Screen (Default Tab) -->
        <div class="tab-content active" id="homeTab">
            <div class="home-screen">
                <div class="welcome-message">
                    Welcome to Class Stacks Browser!<br>
                    <small style="font-size: 1rem; color: #666;" id="browserStatusMessage">You can browse the web freely. School-wide restrictions apply.</small>
                </div>
                
                <div class="website-grid">
                    <div class="website-item" onclick="visitWebsiteInNewTab('https://www.google.com')">
                        <div class="website-icon">üîç</div>
                        <div>Google</div>
                    </div>
                    <div class="website-item" onclick="visitWebsiteInNewTab('https://www.wikipedia.org')">
                        <div class="website-icon">üåê</div>
                        <div>Wikipedia</div>
                    </div>
                    <div class="website-item" onclick="visitWebsiteInNewTab('https://www.khanacademy.org')">
                        <div class="website-icon">üìö</div>
                        <div>Khan Academy</div>
                    </div>
                    <div class="website-item" onclick="visitWebsiteInNewTab('https://stackoverflow.com')">
                        <div class="website-icon">üí°</div>
                        <div>Stack Overflow</div>
                    </div>
                    <div class="website-item" onclick="visitWebsiteInNewTab('https://github.com')">
                        <div class="website-icon">üíª</div>
                        <div>GitHub</div>
                    </div>
                    <div class="website-item" onclick="visitWebsiteInNewTab('https://code.org')">
                        <div class="website-icon">üë®‚Äçüíª</div>
                        <div>Code.org</div>
                    </div>
                    <div class="website-item" onclick="visitWebsiteInNewTab('https://www.duolingo.com')">
                        <div class="website-icon">ü¶â</div>
                        <div>Duolingo</div>
                    </div>
                    <div class="website-item" onclick="visitWebsiteInNewTab('https://www.coursera.org')">
                        <div class="website-icon">üéì</div>
                        <div>Coursera</div>
                    </div>
                </div>
                
                <div style="margin-top: 40px; padding: 20px; background: #f8f9fa; border-radius: 10px; max-width: 600px;">
                    <h3>Quick Tips:</h3>
                    <ul style="text-align: left; margin-top: 10px;">
                        <li>Use <strong>Ctrl+T</strong> to open a new tab</li>
                        <li>Use <strong>Ctrl+W</strong> to close the current tab</li>
                        <li>Use <strong>Ctrl+Tab</strong> to switch between tabs</li>
                        <li>Type URLs in the address bar and press Enter to visit websites</li>
                        <li>Use <strong>Ctrl+B</strong> to toggle the bypass code panel</li>
                        <li>Visit <strong>browser://whiteboard</strong> to join whiteboard sessions</li>
                        <li>Visit <strong>browser://settings</strong> to customize your browser</li>
                        <li>Visit <strong>browser://addons</strong> to install browser extensions</li>
                        <li>Visit <strong>browser://connect</strong> to connect to a class</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Connection Page -->
    <div class="connection-container" id="connectionContainer">
        <div class="connection-header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="font-size: 1.5rem;">üîó</div>
                <div>
                    <div style="font-weight: 600; font-size: 1.2rem;">Connect to Class</div>
                    <div style="font-size: 0.9rem;">Enter class connection code</div>
                </div>
            </div>
            <div>
                <button class="btn" onclick="exitConnectionPage()" style="padding: 8px 15px;">Back to Browser</button>
            </div>
        </div>
        
        <div class="connection-content">
            <div class="connection-icon">üîó</div>
            <div class="connection-title">Connect to Class</div>
            <div class="connection-subtitle">
                Enter your class connection code to join a class session. 
                Your teacher will provide this code.
            </div>
            
            <div class="form-group" style="max-width: 300px;">
                <label for="classConnectionCode">Class Connection Code</label>
                <input type="text" id="classConnectionCode" placeholder="Enter class code" style="text-align: center; font-size: 1.2rem; letter-spacing: 2px;">
            </div>
            
            <div class="connection-actions">
                <button class="btn btn-success" onclick="connectToClass()">Connect to Class</button>
            </div>
            
            <div id="connectionStatusMessage" style="margin-top: 20px; padding: 10px; border-radius: 5px; display: none;"></div>
            
            <div class="connection-instructions">
                <h3>How Class Connection Works:</h3>
                <ol>
                    <li>Your teacher will provide a class connection code</li>
                    <li>Enter the code above to join the class session</li>
                    <li>Once connected, class-specific restrictions will apply</li>
                    <li>You can still browse when not in an active class (school-wide restrictions only)</li>
                    <li>Class connection remains active until you disconnect or the class ends</li>
                </ol>
            </div>
        </div>
    </div>
    
    <!-- Whiteboard -->
    <div class="whiteboard-container" id="whiteboardContainer">
        <div class="whiteboard-header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="font-size: 1.5rem;">üìù</div>
                <div>
                    <div style="font-weight: 600; font-size: 1.2rem;">Class Stacks Whiteboard</div>
                    <div style="font-size: 0.9rem;">Collaborative Whiteboard Session</div>
                </div>
            </div>
            <div>
                <button class="btn" onclick="exitWhiteboard()" style="padding: 8px 15px;">Exit Whiteboard</button>
            </div>
        </div>
        
        <div class="whiteboard-controls">
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="whiteboard-tool active" data-tool="pen" onclick="selectTool('pen')">‚úèÔ∏è Pen</button>
                <button class="whiteboard-tool" data-tool="eraser" onclick="selectTool('eraser')">üßΩ Eraser</button>
                <button class="whiteboard-tool" data-tool="line" onclick="selectTool('line')">üìè Line</button>
                <button class="whiteboard-tool" data-tool="rectangle" onclick="selectTool('rectangle')">‚¨ú Rectangle</button>
                <button class="whiteboard-tool" data-tool="circle" onclick="selectTool('circle')">‚≠ï Circle</button>
                <button class="whiteboard-tool" data-tool="text" onclick="selectTool('text')">üî§ Text</button>
                <input type="color" id="drawingColor" value="#000000" onchange="changeColor(this.value)">
                <input type="range" id="brushSize" min="1" max="20" value="3" onchange="changeBrushSize(this.value)">
                <button class="btn btn-danger" onclick="clearWhiteboard()">Clear</button>
            </div>
        </div>
        
        <div class="whiteboard-canvas-container">
            <canvas class="whiteboard-canvas" id="whiteboardCanvas"></canvas>
            <div class="whiteboard-users" id="whiteboardUsers">
                <h4>Active Users</h4>
                <div id="usersList">
                    <div class="user-indicator">
                        <div class="user-color" style="background: #4361ee;"></div>
                        <span>You</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings -->
    <div class="settings-container" id="settingsContainer">
        <div class="settings-header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="font-size: 1.5rem;">‚öôÔ∏è</div>
                <div>
                    <div style="font-weight: 600; font-size: 1.2rem;">Browser Settings</div>
                    <div style="font-size: 0.9rem;">Customize your browsing experience</div>
                </div>
            </div>
            <div>
                <button class="btn" onclick="exitSettings()" style="padding: 8px 15px;">Back to Browser</button>
            </div>
        </div>
        
        <div class="settings-content">
            <div class="settings-section">
                <div class="settings-section-title">Appearance</div>
                <div class="theme-options">
                    <div class="theme-option active" onclick="selectTheme('default')">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #4361ee 0%, #3f37c9 100%);"></div>
                        <div>Default Blue</div>
                    </div>
                    <div class="theme-option" onclick="selectTheme('dark')">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);"></div>
                        <div>Dark Mode</div>
                    </div>
                    <div class="theme-option" onclick="selectTheme('green')">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #2a9d8f 0%, #219653 100%);"></div>
                        <div>Green Theme</div>
                    </div>
                    <div class="theme-option" onclick="selectTheme('purple')">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #6a0dad 0%, #8a2be2 100%);"></div>
                        <div>Purple Theme</div>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">Browser Behavior</div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="newTabBlank" checked> Open new tabs with blank page
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="showHomeButton"> Show home button in navigation
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="autoComplete"> Enable address bar autocomplete
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">Privacy & Security</div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="blockPopups" checked> Block pop-up windows
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="clearHistoryOnExit"> Clear browsing history on exit
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="doNotTrack"> Send "Do Not Track" requests
                    </label>
                </div>
            </div>
            
            <button class="btn" onclick="saveSettings()" style="width: auto;">Save Settings</button>
        </div>
    </div>
    
    <!-- Addons -->
    <div class="addons-container" id="addonsContainer">
        <div class="addons-header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="font-size: 1.5rem;">üß©</div>
                <div>
                    <div style="font-weight: 600; font-size: 1.2rem;">Browser Addons</div>
                    <div style="font-size: 0.9rem;">Enhance your browsing experience</div>
                </div>
            </div>
            <div>
                <button class="btn" onclick="exitAddons()" style="padding: 8px 15px;">Back to Browser</button>
            </div>
        </div>
        
        <div class="addons-content">
            <div class="addons-grid">
                <div class="addon-card">
                    <div class="addon-header">
                        <div class="addon-icon">üìö</div>
                        <div class="addon-title">Dictionary Extension</div>
                    </div>
                    <div class="addon-description">
                        Double-click any word to see its definition. Perfect for reading and research.
                    </div>
                    <div class="addon-actions">
                        <div style="font-size: 0.9rem; color: #666;">Version 1.2</div>
                        <button class="btn" style="padding: 5px 10px;" onclick="installAddon('dictionary')">Install</button>
                    </div>
                </div>
                
                <div class="addon-card">
                    <div class="addon-header">
                        <div class="addon-icon">üîç</div>
                        <div class="addon-title">Quick Search</div>
                    </div>
                    <div class="addon-description">
                        Select text and right-click to search quickly without leaving the page.
                    </div>
                    <div class="addon-actions">
                        <div style="font-size: 0.9rem; color: #666;">Version 1.0</div>
                        <button class="btn" style="padding: 5px 10px;" onclick="installAddon('quickSearch')">Install</button>
                    </div>
                </div>
                
                <div class="addon-card">
                    <div class="addon-header">
                        <div class="addon-icon">üìù</div>
                        <div class="addon-title">Note Taker</div>
                    </div>
                    <div class="addon-description">
                        Take notes while browsing and save them for later review.
                    </div>
                    <div class="addon-actions">
                        <div style="font-size: 0.9rem; color: #666;">Version 1.1</div>
                        <button class="btn" style="padding: 5px 10px;" onclick="installAddon('noteTaker')">Install</button>
                    </div>
                </div>
                
                <div class="addon-card">
                    <div class="addon-header">
                        <div class="addon-icon">‚è±Ô∏è</div>
                        <div class="addon-title">Focus Timer</div>
                    </div>
                    <div class="addon-description">
                        Set timers for focused work sessions with breaks to maximize productivity.
                    </div>
                    <div class="addon-actions">
                        <div style="font-size: 0.9rem; color: #666;">Version 1.3</div>
                        <button class="btn" style="padding: 5px 10px;" onclick="installAddon('focusTimer')">Install</button>
                    </div>
                </div>
                
                <div class="addon-card">
                    <div class="addon-header">
                        <div class="addon-icon">üé®</div>
                        <div class="addon-title">Dark Reader</div>
                    </div>
                    <div class="addon-description">
                        Automatically apply dark mode to all websites for comfortable night browsing.
                    </div>
                    <div class="addon-actions">
                        <div style="font-size: 0.9rem; color: #666;">Version 1.5</div>
                        <button class="btn" style="padding: 5px 10px;" onclick="installAddon('darkReader')">Install</button>
                    </div>
                </div>
                
                <div class="addon-card">
                    <div class="addon-header">
                        <div class="addon-icon">üìä</div>
                        <div class="addon-title">Productivity Tracker</div>
                    </div>
                    <div class="addon-description">
                        Track how you spend your time online and get insights on your browsing habits.
                    </div>
                    <div class="addon-actions">
                        <div style="font-size: 0.9rem; color: #666;">Version 1.2</div>
                        <button class="btn" style="padding: 5px 10px;" onclick="installAddon('productivityTracker')">Install</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bypass Panel -->
    <div class="bypass-panel" id="bypassPanel">
        <div class="bypass-header">
            <div><strong>Bypass Code</strong></div>
            <button class="bypass-toggle" onclick="toggleBypassPanel()">Hide</button>
        </div>
        <div>
            <input type="text" class="bypass-input" id="bypassCodeInput" placeholder="Enter bypass code">
            <button class="bypass-submit" onclick="submitBypassCode()">Submit</button>
        </div>
        <div id="bypassStatus" style="margin-top: 10px; font-size: 0.8rem;"></div>
    </div>
    
    <!-- Teacher Message -->
    <div class="teacher-message" id="teacherMessage">
        <h4>üì© Message from Teacher</h4>
        <div class="message-content" id="messageContent"></div>
        <div class="message-from" id="messageFrom"></div>
        <button class="btn" onclick="closeMessage()" style="margin-top: 10px; padding: 8px 15px;">OK</button>
    </div>
    
    <!-- Screenshot Overlay -->
    <div class="screenshot-overlay" id="screenshotOverlay">
        <div class="screenshot-container">
            <h3>üì∏ Screenshot Requested</h3>
            <p>Your teacher is requesting a screenshot of your screen.</p>
            <canvas id="screenshotCanvas" class="screenshot-canvas" width="800" height="450"></canvas>
            <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                <button class="btn btn-success" onclick="takeScreenshot()">Take Screenshot</button>
                <button class="btn btn-danger" onclick="cancelScreenshot()">Cancel</button>
            </div>
        </div>
    </div>
    
    <div class="connection-status" id="connectionStatus">üõú Connected</div>

    <script>
        // Global variables
        let currentStudent = null;
        let studentId = null;
        let currentSchoolCode = '';
        let currentClassCode = '';
        let tabs = [];
        let activeTabIndex = 0;
        let updateInterval;
        let screenshotInterval;
        let bypassActive = false;
        let bypassExpiry = 0;
        let installedAddons = [];
        let connectionCode = '';
        
        // Whiteboard variables
        let whiteboardActive = false;
        let currentTool = 'pen';
        let drawingColor = '#000000';
        let brushSize = 3;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        
        // Tab class
        class Tab {
            constructor(id, title = 'New Tab', url = '', favicon = 'üåê') {
                this.id = id;
                this.title = title;
                this.url = url;
                this.favicon = favicon;
                this.history = [];
                this.historyIndex = -1;
                this.canGoBack = false;
                this.canGoForward = false;
                this.iframe = null;
                this.contentElement = null;
            }
            
            navigateTo(url) {
                if (this.url) {
                    this.history.push(this.url);
                    this.historyIndex = this.history.length - 1;
                }
                this.url = url;
                this.updateNavigationState();
            }
            
            goBack() {
                if (this.historyIndex > 0) {
                    this.historyIndex--;
                    this.url = this.history[this.historyIndex];
                    this.updateNavigationState();
                    return true;
                }
                return false;
            }
            
            goForward() {
                if (this.historyIndex < this.history.length - 1) {
                    this.historyIndex++;
                    this.url = this.history[this.historyIndex];
                    this.updateNavigationState();
                    return true;
                }
                return false;
            }
            
            updateNavigationState() {
                this.canGoBack = this.historyIndex > 0;
                this.canGoForward = this.historyIndex < this.history.length - 1;
            }
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Check for existing session
            const savedStudent = localStorage.getItem('currentStudent');
            if (savedStudent) {
                try {
                    currentStudent = JSON.parse(savedStudent);
                    studentId = currentStudent.id;
                    currentSchoolCode = currentStudent.schoolCode;
                    currentClassCode = currentStudent.classCode || '';
                    
                    // Verify the school still exists
                    const data = getSharedData();
                    if (data.students && data.students[studentId]) {
                        showStudentBrowser();
                    } else {
                        localStorage.removeItem('currentStudent');
                        showError('Session expired. Please log in again.');
                    }
                } catch (e) {
                    localStorage.removeItem('currentStudent');
                    showError('Invalid session data. Please log in again.');
                }
            }
            
            // Set up keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (document.getElementById('studentBrowser').style.display === 'flex') {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key) {
                            case 't':
                                e.preventDefault();
                                createNewTab();
                                break;
                            case 'w':
                                e.preventDefault();
                                closeCurrentTab();
                                break;
                            case 'r':
                                e.preventDefault();
                                reloadTab();
                                break;
                            case 'b':
                                e.preventDefault();
                                toggleBypassPanel();
                                break;
                        }
                    }
                    
                    if (e.key === 'F12') {
                        e.preventDefault();
                        toggleBypassPanel();
                    }
                    
                    // Enter key in URL bar
                    if (e.key === 'Enter' && document.activeElement.id === 'browserUrl') {
                        navigateCurrentTab();
                    }
                }
            });
        });
        
        // Student authentication
        document.getElementById('authForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const schoolCode = document.getElementById('schoolCode').value.trim().toUpperCase();
            
            if (!firstName || !lastName) {
                showError('Please enter both first and last name');
                return;
            }
            
            if (!schoolCode) {
                showError('Please enter a school code');
                return;
            }
            
            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Connecting...';
            submitBtn.disabled = true;
            
            // Check if school code exists
            setTimeout(() => {
                const data = getSharedData();
                const schoolExists = Object.values(data.schools).find(school => 
                    school.schoolCode === schoolCode
                );
                
                if (schoolExists) {
                    // School code is valid - create student session
                    const studentName = `${firstName} ${lastName}`;
                    studentId = 'student_' + btoa(studentName + schoolCode).replace(/[^a-zA-Z0-9]/g, '');
                    currentSchoolCode = schoolCode;
                    
                    currentStudent = {
                        id: studentId,
                        firstName: firstName,
                        lastName: lastName,
                        name: studentName,
                        schoolCode: schoolCode,
                        classCode: '',
                        lastActive: Date.now(),
                        device: getDeviceInfo(),
                        connected: true,
                        tabs: [],
                        activeTab: 0
                    };
                    
                    // Register student with school
                    registerStudent();
                    
                    // Save student data
                    localStorage.setItem('currentStudent', JSON.stringify(currentStudent));
                    showStudentBrowser();
                } else {
                    showError(`School code "${schoolCode}" not found. Please check with your teacher.`);
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            }, 1000);
        });
        
        // Register student with school
        function registerStudent() {
            const data = getSharedData();
            data.students = data.students || {};
            data.students[currentStudent.id] = currentStudent;
            
            // Log the connection
            if (!data.activityLogs) data.activityLogs = {};
            if (!data.activityLogs[studentId]) data.activityLogs[studentId] = [];
            data.activityLogs[studentId].push({
                action: 'Student connected to school',
                timestamp: Date.now()
            });
            
            saveSharedData(data);
        }
        
        // Show student browser
        function showStudentBrowser() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('studentBrowser').style.display = 'flex';
            document.getElementById('studentNameDisplay').textContent = currentStudent.name;
            document.getElementById('studentAvatar').textContent = currentStudent.firstName.charAt(0).toUpperCase();
            document.getElementById('schoolCodeDisplay').textContent = currentSchoolCode;
            
            // Update class status
            updateClassStatus();
            
            // Initialize tabs
            initializeTabs();
            
            // Show bypass panel
            document.getElementById('bypassPanel').style.display = 'block';
            
            // Start activity reporting
            startActivityReporting();
            
            // Start monitoring for teacher commands
            startStudentMonitoring();
            
            // Start automatic screenshots
            startAutomaticScreenshots();
        }
        
        // Update class status display
        function updateClassStatus() {
            const classStatusElement = document.getElementById('classStatus');
            const browserStatusElement = document.getElementById('browserStatusMessage');
            
            if (currentClassCode) {
                const data = getSharedData();
                const classItem = data.classes[currentClassCode];
                const className = classItem ? classItem.name : currentClassCode;
                
                classStatusElement.textContent = `Class: ${className}`;
                classStatusElement.className = 'class-status status-active';
                browserStatusElement.textContent = `You are in an active class. Class and school restrictions apply.`;
            } else {
                classStatusElement.textContent = 'No Active Class';
                classStatusElement.className = 'class-status status-inactive';
                browserStatusElement.textContent = 'You can browse the web freely. School-wide restrictions apply.';
            }
        }
        
        // Initialize tabs
        function initializeTabs() {
            tabs = [];
            
            // Create home tab
            const homeTab = new Tab('home', 'Home', '');
            tabs.push(homeTab);
            activeTabIndex = 0;
            
            // Update tab display
            updateTabDisplay();
            updateNavigationButtons();
        }
        
        // Create a new tab
        function createNewTab(url = '', title = 'New Tab') {
            const tabId = 'tab_' + Date.now();
            const newTab = new Tab(tabId, title, url);
            tabs.push(newTab);
            activeTabIndex = tabs.length - 1;
            
            // Create tab element
            updateTabDisplay();
            
            // Create tab content
            createTabContent(tabId);
            
            // If URL provided, navigate to it
            if (url) {
                navigateToUrl(url, activeTabIndex);
            } else {
                // New tabs start with blank page
                goHomeTab(activeTabIndex);
            }
            
            // Update student data
            updateStudentTabs();
            
            return newTab;
        }
        
        // Close current tab
        function closeCurrentTab() {
            if (tabs.length <= 1) {
                // Don't close the last tab
                return;
            }
            
            // Remove tab from array
            tabs.splice(activeTabIndex, 1);
            
            // Adjust active tab index if needed
            if (activeTabIndex >= tabs.length) {
                activeTabIndex = tabs.length - 1;
            }
            
            // Update display
            updateTabDisplay();
            updateStudentTabs();
        }
        
        // Close specific tab
        function closeTab(tabIndex) {
            if (tabs.length <= 1) {
                return;
            }
            
            tabs.splice(tabIndex, 1);
            
            if (activeTabIndex >= tabIndex) {
                activeTabIndex = Math.max(0, activeTabIndex - 1);
            }
            
            updateTabDisplay();
            updateStudentTabs();
        }
        
        // Switch to a tab
        function switchToTab(tabIndex) {
            if (tabIndex >= 0 && tabIndex < tabs.length) {
                activeTabIndex = tabIndex;
                updateTabDisplay();
                updateNavigationButtons();
                updateUrlBar();
            }
        }
        
        // Update tab display
        function updateTabDisplay() {
            const tabBar = document.getElementById('tabBar');
            const newTabBtn = tabBar.querySelector('.new-tab-btn');
            
            // Clear existing tabs (except new tab button)
            tabBar.innerHTML = '';
            
            // Add all tabs
            tabs.forEach((tab, index) => {
                const tabElement = document.createElement('div');
                tabElement.className = `tab ${index === activeTabIndex ? 'active' : ''}`;
                tabElement.dataset.tabIndex = index;
                
                tabElement.innerHTML = `
                    <div class="tab-favicon">${tab.favicon}</div>
                    <div class="tab-title">${tab.title}</div>
                    <div class="tab-close" onclick="event.stopPropagation(); closeTab(${index})">√ó</div>
                `;
                
                tabElement.addEventListener('click', () => switchToTab(index));
                
                tabBar.appendChild(tabElement);
            });
            
            // Add new tab button
            tabBar.appendChild(newTabBtn);
            
            // Update tab content visibility
            updateTabContentVisibility();
        }
        
        // Update tab content visibility
        function updateTabContentVisibility() {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
                content.classList.remove('active');
            });
            
            // Show active tab content
            const activeTab = tabs[activeTabIndex];
            let tabContent = document.getElementById(activeTab.id);
            
            if (!tabContent) {
                createTabContent(activeTab.id);
                tabContent = document.getElementById(activeTab.id);
            }
            
            if (tabContent) {
                tabContent.style.display = 'flex';
                tabContent.classList.add('active');
            }
        }
        
        // Create tab content
        function createTabContent(tabId) {
            const tabContentArea = document.getElementById('tabContentArea');
            
            const tabContent = document.createElement('div');
            tabContent.className = 'tab-content';
            tabContent.id = tabId;
            
            // Add home screen for new tabs
            if (tabId !== 'home') {
                const homeScreen = document.createElement('div');
                homeScreen.className = 'home-screen';
                homeScreen.innerHTML = `
                    <div class="welcome-message">
                        New Tab<br>
                        <small style="font-size: 1rem; color: #666;">Type a URL or search above</small>
                    </div>
                `;
                tabContent.appendChild(homeScreen);
            }
            
            tabContentArea.appendChild(tabContent);
        }
        
        // Update navigation buttons state
        function updateNavigationButtons() {
            const activeTab = tabs[activeTabIndex];
            if (activeTab) {
                document.querySelector('.nav-btn:nth-child(1)').disabled = !activeTab.canGoBack;
                document.querySelector('.nav-btn:nth-child(2)').disabled = !activeTab.canGoForward;
            }
        }
        
        // Update URL bar with current tab's URL
        function updateUrlBar() {
            const activeTab = tabs[activeTabIndex];
            if (activeTab) {
                document.getElementById('browserUrl').value = activeTab.url;
            }
        }
        
        // Navigate current tab
        function navigateCurrentTab() {
            const urlInput = document.getElementById('browserUrl');
            const url = urlInput.value.trim();
            
            if (url) {
                navigateToUrl(url, activeTabIndex);
            }
        }
        
        // Navigate to URL in specific tab
        function navigateToUrl(url, tabIndex) {
            // Check for special browser URLs
            if (url === 'browser://whiteboard') {
                showWhiteboard();
                return;
            } else if (url === 'browser://settings') {
                showSettings();
                return;
            } else if (url === 'browser://addons') {
                showAddons();
                return;
            } else if (url === 'browser://connect') {
                showConnectionPage();
                return;
            }
            
            // Check if bypass is active
            if (bypassActive) {
                // Bypass is active - load website directly
                loadWebsiteDirectly(url, tabIndex);
                return;
            }
            
            // Check if browser is locked
            const data = getSharedData();
            const studentLocked = data.studentLocks && data.studentLocks[studentId];
            
            if (studentLocked) {
                showLockedMessage(tabIndex);
                return;
            }
            
            let fullUrl = url;
            if (!url.startsWith('http')) {
                fullUrl = 'https://' + url;
            }
            
            // Extract domain for blocking check
            const domain = extractDomain(fullUrl);
            
            // Check if website is blocked
            if (isUrlBlocked(domain)) {
                showBlockedMessage(domain, tabIndex);
                return;
            }
            
            // Load website
            loadWebsiteDirectly(url, tabIndex);
        }
        
        // Check if URL is blocked based on current restrictions
        function isUrlBlocked(domain) {
            const data = getSharedData();
            
            // Get school settings
            const school = Object.values(data.schools).find(s => s.schoolCode === currentSchoolCode);
            if (!school) return false;
            
            const schoolSettings = data.schoolSettings && data.schoolSettings[school.id];
            if (!schoolSettings) return false;
            
            // Check school-wide blocked sites
            const schoolBlockedSites = schoolSettings.blockedSites || [];
            const isBlockedBySchool = schoolBlockedSites.some(site => 
                domain.toLowerCase().includes(site.toLowerCase())
            );
            
            // If not in a class, only apply school restrictions
            if (!currentClassCode) {
                return isBlockedBySchool;
            }
            
            // If in a class, check class-specific restrictions
            const classItem = data.classes[currentClassCode];
            if (classItem && classItem.blockedSites) {
                const isBlockedByClass = classItem.blockedSites.some(site => 
                    domain.toLowerCase().includes(site.toLowerCase())
                );
                return isBlockedBySchool || isBlockedByClass;
            }
            
            return isBlockedBySchool;
        }
        
        // Load website directly without CORS proxy
        function loadWebsiteDirectly(url, tabIndex) {
            const tab = tabs[tabIndex];
            tab.navigateTo(url);
            
            // Extract domain for title and favicon
            const domain = extractDomain(url);
            tab.title = getWebsiteName(domain);
            tab.favicon = getWebsiteIcon(domain);
            
            // Show loading message
            showLoadingMessage(tabIndex);
            
            // Update tab display
            updateTabDisplay();
            updateNavigationButtons();
            updateUrlBar();
            
            // Log the website visit
            const sharedData = getSharedData();
            if (!sharedData.activityLogs) sharedData.activityLogs = {};
            if (!sharedData.activityLogs[studentId]) sharedData.activityLogs[studentId] = [];
            sharedData.activityLogs[studentId].push({
                action: `Visited ${getWebsiteName(domain)} (${url})`,
                timestamp: Date.now(),
                classCode: currentClassCode
            });
            
            // Update student data
            updateStudentTabs();
            saveSharedData(sharedData);
            
            // Load the website
            loadWebsiteWithFallback(url, tabIndex);
        }
        
        // Load website with fallback for iframe restrictions
        function loadWebsiteWithFallback(url, tabIndex) {
            const tab = tabs[tabIndex];
            const tabContent = document.getElementById(tab.id);
            
            // Clear existing content
            tabContent.innerHTML = '';
            
            // Create iframe for website
            const iframe = document.createElement('iframe');
            iframe.className = 'website-viewer';
            iframe.src = url;
            iframe.onload = function() {
                // Hide loading message
                hideLoadingMessage(tabIndex);
                
                // Apply addons
                applyAddonsToIframe(iframe);
            };
            iframe.onerror = function() {
                // If iframe fails, show fallback
                showWebsiteFallback(url, tabIndex);
            };
            
            tabContent.appendChild(iframe);
            tab.iframe = iframe;
            tab.contentElement = iframe;
        }
        
        // Show website fallback when iframe fails
        function showWebsiteFallback(url, tabIndex) {
            const tab = tabs[tabIndex];
            const tabContent = document.getElementById(tab.id);
            
            // Clear existing content
            tabContent.innerHTML = '';
            
            const fallback = document.createElement('div');
            fallback.className = 'iframe-fallback';
            fallback.innerHTML = `
                <div style="font-size: 4rem; margin-bottom: 20px;">üåê</div>
                <h2>Website Restricted</h2>
                <p>This website cannot be displayed in the browser due to security restrictions.</p>
                <p style="font-family: monospace; font-size: 0.9rem; margin-top: 10px; background: #f0f0f0; padding: 10px; border-radius: 5px;">${url}</p>
                <div class="fallback-actions">
                    <button class="btn" onclick="openWebsiteInNewWindow('${url}')">Open in New Window</button>
                    <button class="btn" onclick="goHomeTab(${tabIndex})">Return to Home</button>
                </div>
            `;
            
            tabContent.appendChild(fallback);
            tab.contentElement = fallback;
            
            // Hide loading message
            hideLoadingMessage(tabIndex);
        }
        
        // Open website in new window
        function openWebsiteInNewWindow(url) {
            window.open(url, '_blank');
        }
        
        // Show loading message
        function showLoadingMessage(tabIndex) {
            const tab = tabs[tabIndex];
            const tabContent = document.getElementById(tab.id);
            
            // Clear existing content
            tabContent.innerHTML = '';
            
            const loadingMessage = document.createElement('div');
            loadingMessage.className = 'loading-message';
            loadingMessage.innerHTML = `
                <div class="loading-icon">‚è≥</div>
                <h3>Loading Website...</h3>
                <p>Please wait while we load the website.</p>
            `;
            
            tabContent.appendChild(loadingMessage);
        }
        
        // Hide loading message
        function hideLoadingMessage(tabIndex) {
            const tab = tabs[tabIndex];
            const tabContent = document.getElementById(tab.id);
            const loadingMessage = tabContent.querySelector('.loading-message');
            
            if (loadingMessage) {
                loadingMessage.style.display = 'none';
            }
        }
        
        // Show blocked message
        function showBlockedMessage(url, tabIndex) {
            const tab = tabs[tabIndex];
            const tabContent = document.getElementById(tab.id);
            
            // Clear existing content
            tabContent.innerHTML = '';
            
            const blockedMessage = document.createElement('div');
            blockedMessage.className = 'blocked-message';
            blockedMessage.style.display = 'flex';
            blockedMessage.innerHTML = `
                <div class="message-icon">üö´</div>
                <h2>Website Blocked</h2>
                <p>This website has been restricted by your ${currentClassCode ? 'teacher' : 'school'}.</p>
                <p style="font-family: monospace; margin: 10px 0; font-size: 1.1rem;">${url}</p>
                <button class="btn" onclick="goHomeTab(${tabIndex})" style="margin-top: 20px;">Return to Safe Browsing</button>
            `;
            
            tabContent.appendChild(blockedMessage);
            
            // Update student data
            updateStudentTabs();
        }
        
        // Show locked message
        function showLockedMessage(tabIndex) {
            const tab = tabs[tabIndex];
            const tabContent = document.getElementById(tab.id);
            
            // Clear existing content
            tabContent.innerHTML = '';
            
            const lockedMessage = document.createElement('div');
            lockedMessage.className = 'locked-message';
            lockedMessage.style.display = 'flex';
            lockedMessage.innerHTML = `
                <div class="message-icon">üîí</div>
                <h2>Browser Locked</h2>
                <p>Your teacher has locked your browser.</p>
                <p>You cannot access any websites at this time.</p>
                <button class="btn" onclick="goHomeTab(${tabIndex})" style="margin-top: 20px;">Return to Home</button>
            `;
            
            tabContent.appendChild(lockedMessage);
            
            // Update student data
            updateStudentTabs();
        }
        
        // Go to home in specific tab
        function goHomeTab(tabIndex) {
            const tab = tabs[tabIndex];
            const tabContent = document.getElementById(tab.id);
            
            // Clear existing content
            tabContent.innerHTML = '';
            
            // Add home screen
            const homeScreen = document.createElement('div');
            homeScreen.className = 'home-screen';
            homeScreen.innerHTML = `
                <div class="welcome-message">
                    ${tabIndex === 0 ? 'Welcome to Class Stacks Browser!' : 'New Tab'}<br>
                    <small style="font-size: 1rem; color: #666;">Start browsing or try one of the educational sites</small>
                </div>
            `;
            
            tabContent.appendChild(homeScreen);
            
            // Update tab
            tab.url = '';
            tab.title = tabIndex === 0 ? 'Home' : 'New Tab';
            tab.favicon = 'üåê';
            
            updateTabDisplay();
            updateUrlBar();
            updateStudentTabs();
        }
        
        // Go to home in current tab
        function goHome() {
            goHomeTab(activeTabIndex);
        }
        
        // Go back in current tab
        function goBack() {
            const activeTab = tabs[activeTabIndex];
            if (activeTab && activeTab.goBack()) {
                navigateToUrl(activeTab.url, activeTabIndex);
            }
        }
        
        // Go forward in current tab
        function goForward() {
            const activeTab = tabs[activeTabIndex];
            if (activeTab && activeTab.goForward()) {
                navigateToUrl(activeTab.url, activeTabIndex);
            }
        }
        
        // Reload current tab
        function reloadTab() {
            const activeTab = tabs[activeTabIndex];
            if (activeTab && activeTab.url) {
                navigateToUrl(activeTab.url, activeTabIndex);
            }
        }
        
        // Visit website in new tab
        function visitWebsiteInNewTab(url) {
            createNewTab(url);
        }
        
        // Update student tabs data for teacher monitoring
        function updateStudentTabs() {
            if (!currentStudent) return;
            
            currentStudent.tabs = tabs.map(tab => ({
                id: tab.id,
                title: tab.title,
                url: tab.url,
                favicon: tab.favicon
            }));
            
            currentStudent.activeTab = activeTabIndex;
            currentStudent.lastActive = Date.now();
            currentStudent.bypassActive = bypassActive;
            currentStudent.connectionCode = connectionCode;
            currentStudent.classCode = currentClassCode;
            
            // Update in shared data
            const data = getSharedData();
            data.students[currentStudent.id] = currentStudent;
            saveSharedData(data);
            
            localStorage.setItem('currentStudent', JSON.stringify(currentStudent));
        }
        
        // Start activity reporting
        function startActivityReporting() {
            setInterval(() => {
                reportStudentActivity();
            }, 5000);
        }
        
        function startAutomaticScreenshots() {
            screenshotInterval = setInterval(() => {
                takeAutomaticScreenshot();
            }, 2500);
        }
        
        function reportStudentActivity() {
            if (!currentStudent) return;
            
            currentStudent.lastActive = Date.now();
            updateStudentTabs();
            
            // Update connection status
            const statusElement = document.getElementById('connectionStatus');
            statusElement.style.background = 'var(--success)';
            statusElement.textContent = 'üõú Connected';
        }
        
        function startStudentMonitoring() {
            setInterval(() => {
                checkForMessages();
                checkForTeacherControl();
                checkForScreenshotRequests();
                reportStudentActivity();
                
                // Check if bypass has expired
                if (bypassActive && Date.now() > bypassExpiry) {
                    bypassActive = false;
                    bypassExpiry = 0;
                    updateStudentTabs();
                    
                    // Show notification
                    const statusElement = document.getElementById('bypassStatus');
                    statusElement.textContent = 'Bypass expired';
                    statusElement.style.color = 'var(--danger)';
                }
            }, 2000);
        }
        
        // Connection Page Functions
        function showConnectionPage() {
            document.getElementById('studentBrowser').style.display = 'none';
            document.getElementById('connectionContainer').style.display = 'flex';
        }
        
        function exitConnectionPage() {
            document.getElementById('connectionContainer').style.display = 'none';
            document.getElementById('studentBrowser').style.display = 'flex';
        }
        
        function connectToClass() {
            const classCode = document.getElementById('classConnectionCode').value.trim().toUpperCase();
            
            if (!classCode) {
                showConnectionStatus('Please enter a class code', 'error');
                return;
            }
            
            const data = getSharedData();
            const classExists = data.classes && data.classes[classCode];
            
            if (classExists) {
                // Connect to class
                currentClassCode = classCode;
                currentStudent.classCode = classCode;
                
                // Update student data
                updateStudentTabs();
                
                // Update display
                updateClassStatus();
                
                // Show success message
                showConnectionStatus('Successfully connected to class!', 'success');
                
                // Log the connection
                if (!data.activityLogs) data.activityLogs = {};
                if (!data.activityLogs[studentId]) data.activityLogs[studentId] = [];
                data.activityLogs[studentId].push({
                    action: `Connected to class ${classCode}`,
                    timestamp: Date.now()
                });
                
                saveSharedData(data);
                
                // Return to browser after 2 seconds
                setTimeout(() => {
                    exitConnectionPage();
                }, 2000);
            } else {
                showConnectionStatus('Class code not found. Please check with your teacher.', 'error');
            }
        }
        
        function showConnectionStatus(message, type) {
            const statusElement = document.getElementById('connectionStatusMessage');
            statusElement.textContent = message;
            statusElement.style.background = type === 'success' ? 'var(--success)' : 'var(--danger)';
            statusElement.style.color = 'white';
            statusElement.style.display = 'block';
        }
        
        // Bypass code functionality
        function toggleBypassPanel() {
            const panel = document.getElementById('bypassPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        function submitBypassCode() {
            const codeInput = document.getElementById('bypassCodeInput');
            const code = codeInput.value.trim();
            const statusElement = document.getElementById('bypassStatus');
            
            if (!code) {
                statusElement.textContent = 'Please enter a code';
                statusElement.style.color = 'var(--danger)';
                return;
            }
            
            const data = getSharedData();
            const bypassCode = data.bypassCodes && data.bypassCodes[code];
            
            if (bypassCode && !isBypassCodeExpired(bypassCode) && !isBypassCodeUsedUp(bypassCode)) {
                // Valid bypass code
                bypassCode.usageCount = (bypassCode.usageCount || 0) + 1;
                bypassActive = true;
                bypassExpiry = Date.now() + (30 * 60 * 1000); // 30 minutes
                
                statusElement.textContent = 'Bypass activated for 30 minutes!';
                statusElement.style.color = 'var(--success)';
                
                // Update student data
                updateStudentTabs();
                saveSharedData(data);
                
                // Clear input
                codeInput.value = '';
                
                // Auto-hide after success
                setTimeout(() => {
                    document.getElementById('bypassPanel').style.display = 'none';
                }, 3000);
            } else {
                statusElement.textContent = 'Invalid or expired bypass code';
                statusElement.style.color = 'var(--danger)';
            }
        }
        
        function isBypassCodeExpired(bypassCode) {
            return Date.now() > bypassCode.expiry;
        }
        
        function isBypassCodeUsedUp(bypassCode) {
            return bypassCode.usageCount >= bypassCode.maxUsage;
        }
        
        // Check for teacher messages
        function checkForMessages() {
            if (!studentId) return;
            
            const data = getSharedData();
            const messages = data.messages || {};
            const studentMessages = messages[studentId];
            
            if (studentMessages && studentMessages.length > 0) {
                const latestMessage = studentMessages[studentMessages.length - 1];
                
                // Only show if it's a new message
                if (!currentStudent.lastMessage || currentStudent.lastMessage.timestamp !== latestMessage.timestamp) {
                    currentStudent.lastMessage = latestMessage;
                    showMessage(latestMessage.text, latestMessage.from);
                }
            }
        }
        
        function showMessage(message, from) {
            document.getElementById('messageContent').textContent = message;
            document.getElementById('messageFrom').textContent = `From: ${from}`;
            document.getElementById('teacherMessage').style.display = 'block';
        }
        
        function closeMessage() {
            document.getElementById('teacherMessage').style.display = 'none';
        }
        
        // Check for teacher control commands
        function checkForTeacherControl() {
            if (!studentId) return;
            
            const data = getSharedData();
            const teacherControl = data.teacherControl || {};
            const controlCommand = teacherControl[studentId];
            
            if (controlCommand && controlCommand.action === 'openTab') {
                // Teacher is opening a tab for the student
                createNewTab(controlCommand.url);
                
                // Clear the control command
                delete teacherControl[studentId];
                data.teacherControl = teacherControl;
                saveSharedData(data);
            } else if (controlCommand && controlCommand.action === 'closeTab') {
                // Close current tab and go home
                goHome();
                
                // Clear the control command
                delete teacherControl[studentId];
                data.teacherControl = teacherControl;
                saveSharedData(data);
            }
        }
        
        // Check for screenshot requests
        function checkForScreenshotRequests() {
            if (!studentId) return;
            
            const data = getSharedData();
            const screenshots = data.screenshots || {};
            const screenshotRequest = screenshots[studentId];
            
            if (screenshotRequest && screenshotRequest.requested) {
                // Show screenshot overlay
                document.getElementById('screenshotOverlay').style.display = 'flex';
                
                // Mark request as handled
                screenshotRequest.requested = false;
                saveSharedData(data);
            }
        }
        
        // Take automatic screenshot
        function takeAutomaticScreenshot() {
            if (!studentId) return;
            
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            // Set canvas size to match browser content
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            // Draw browser representation
            drawBrowserRepresentation(context, canvas.width, canvas.height);
            
            // Convert to data URL and save
            const imageData = canvas.toDataURL('image/png');
            
            const data = getSharedData();
            if (!data.screenshots) data.screenshots = {};
            data.screenshots[studentId] = {
                imageData: imageData,
                timestamp: Date.now(),
                requested: false
            };
            
            saveSharedData(data);
        }
        
        // Take manual screenshot (when requested by teacher)
        function takeScreenshot() {
            const canvas = document.getElementById('screenshotCanvas');
            const context = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = 800;
            canvas.height = 450;
            
            // Draw browser representation
            drawBrowserRepresentation(context, canvas.width, canvas.height);
            
            // Convert to data URL and save
            const imageData = canvas.toDataURL('image/png');
            
            const data = getSharedData();
            if (!data.screenshots) data.screenshots = {};
            data.screenshots[studentId] = {
                imageData: imageData,
                timestamp: Date.now(),
                requested: false
            };
            
            saveSharedData(data);
            
            // Hide overlay
            document.getElementById('screenshotOverlay').style.display = 'none';
        }
        
        function cancelScreenshot() {
            document.getElementById('screenshotOverlay').style.display = 'none';
        }
        
        // Draw browser representation for screenshots
        function drawBrowserRepresentation(ctx, width, height) {
            const activeTab = tabs[activeTabIndex];
            
            // Draw browser background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, width, height);
            
            // Draw browser header
            ctx.fillStyle = '#4361ee';
            ctx.fillRect(0, 0, width, 70);
            
            // Draw student info
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 16px Arial';
            ctx.fillText(`${currentStudent.name} - ${currentSchoolCode}`, 20, 40);
            
            // Draw class status
            if (currentClassCode) {
                ctx.font = '12px Arial';
                ctx.fillText(`Class: ${currentClassCode}`, 20, 60);
            }
            
            // Draw tab bar
            ctx.fillStyle = '#f1f3f4';
            ctx.fillRect(0, 70, width, 50);
            
            // Draw active tab
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(10, 75, 200, 40);
            ctx.fillStyle = '#4361ee';
            ctx.fillRect(10, 115, 200, 5);
            
            // Draw tab title
            ctx.fillStyle = '#000000';
            ctx.font = '14px Arial';
            ctx.fillText(activeTab.title || 'New Tab', 40, 100);
            
            // Draw URL bar
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 120, width, 50);
            ctx.fillStyle = '#e1e5ee';
            ctx.fillRect(20, 135, width - 40, 30);
            
            // Draw URL
            ctx.fillStyle = '#000000';
            ctx.font = '14px Arial';
            ctx.fillText(activeTab.url || 'Class Stacks Browser', 30, 155);
            
            // Draw content area
            if (activeTab.url) {
                // Draw website preview
                const domain = extractDomain(activeTab.url);
                const websiteName = getWebsiteName(domain);
                const websiteColor = getWebsiteColor(domain);
                
                ctx.fillStyle = websiteColor;
                ctx.fillRect(0, 170, width, 120);
                
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 20px Arial';
                ctx.fillText(websiteName, 40, 210);
                
                ctx.font = '14px Arial';
                ctx.fillText(activeTab.url, 40, 235);
                
                ctx.fillStyle = '#f8f9fa';
                ctx.fillRect(0, 290, width, height - 290);
                
                ctx.fillStyle = '#666666';
                ctx.font = '14px Arial';
                ctx.fillText('Website content would appear here', 40, 320);
            } else {
                // Draw home screen
                ctx.fillStyle = '#f8f9fa';
                ctx.fillRect(0, 170, width, height - 170);
                
                ctx.fillStyle = '#4361ee';
                ctx.font = 'bold 24px Arial';
                ctx.fillText('Class Stacks Browser', width/2 - 100, 220);
                
                ctx.fillStyle = '#666666';
                ctx.font = '16px Arial';
                ctx.fillText('Educational Browser - Teacher Monitored', width/2 - 150, 250);
                
                // Draw quick access icons
                const websites = ['Google', 'Wikipedia', 'Khan Academy', 'GitHub'];
                for (let i = 0; i < websites.length; i++) {
                    const x = 40 + (i * 120);
                    const y = 300;
                    
                    ctx.fillStyle = '#e9ecef';
                    ctx.fillRect(x, y, 80, 80);
                    
                    ctx.fillStyle = '#000000';
                    ctx.font = '12px Arial';
                    ctx.fillText(websites[i], x, y + 100);
                }
            }
            
            // Draw student info overlay
            ctx.fillStyle = 'rgba(0,0,0,0.7)';
            ctx.fillRect(width - 300, height - 60, 300, 60);
            
            ctx.fillStyle = '#ffffff';
            ctx.font = '12px Arial';
            ctx.fillText(`Student: ${currentStudent.name}`, width - 280, height - 40);
            ctx.fillText(`School: ${currentSchoolCode}`, width - 280, height - 20);
            if (currentClassCode) {
                ctx.fillText(`Class: ${currentClassCode}`, width - 140, height - 20);
            }
            ctx.fillText(`Time: ${new Date().toLocaleTimeString()}`, width - 140, height - 40);
        }
        
        // Whiteboard functions
        function showWhiteboard() {
            document.getElementById('studentBrowser').style.display = 'none';
            document.getElementById('whiteboardContainer').style.display = 'flex';
            
            // Initialize whiteboard canvas
            const canvas = document.getElementById('whiteboardCanvas');
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
            
            // Set up drawing events
            setupWhiteboardEvents();
        }
        
        function exitWhiteboard() {
            document.getElementById('whiteboardContainer').style.display = 'none';
            document.getElementById('studentBrowser').style.display = 'flex';
        }
        
        function setupWhiteboardEvents() {
            const canvas = document.getElementById('whiteboardCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            function startDrawing(e) {
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                lastX = e.clientX - rect.left;
                lastY = e.clientY - rect.top;
            }
            
            function draw(e) {
                if (!isDrawing) return;
                
                const rect = canvas.getBoundingClientRect();
                const currentX = e.clientX - rect.left;
                const currentY = e.clientY - rect.top;
                
                ctx.strokeStyle = drawingColor;
                ctx.lineWidth = brushSize;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(currentX, currentY);
                ctx.stroke();
                
                lastX = currentX;
                lastY = currentY;
            }
            
            function stopDrawing() {
                isDrawing = false;
            }
        }
        
        function selectTool(tool) {
            currentTool = tool;
            
            // Update tool buttons
            document.querySelectorAll('.whiteboard-tool').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.querySelector(`.whiteboard-tool[data-tool="${tool}"]`).classList.add('active');
        }
        
        function changeColor(color) {
            drawingColor = color;
        }
        
        function changeBrushSize(size) {
            brushSize = parseInt(size);
        }
        
        function clearWhiteboard() {
            const canvas = document.getElementById('whiteboardCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        // Settings functions
        function showSettings() {
            document.getElementById('studentBrowser').style.display = 'none';
            document.getElementById('settingsContainer').style.display = 'flex';
        }
        
        function exitSettings() {
            document.getElementById('settingsContainer').style.display = 'none';
            document.getElementById('studentBrowser').style.display = 'flex';
        }
        
        function selectTheme(theme) {
            // Update theme buttons
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
            });
            
            document.querySelector(`.theme-option[onclick="selectTheme('${theme}')"]`).classList.add('active');
            
            // In a real implementation, this would change the browser theme
            showSuccess(`Theme changed to ${theme}`);
        }
        
        function saveSettings() {
            // In a real implementation, this would save the settings
            showSuccess('Settings saved successfully!');
        }
        
        // Addons functions
        function showAddons() {
            document.getElementById('studentBrowser').style.display = 'none';
            document.getElementById('addonsContainer').style.display = 'flex';
        }
        
        function exitAddons() {
            document.getElementById('addonsContainer').style.display = 'none';
            document.getElementById('studentBrowser').style.display = 'flex';
        }
        
        function installAddon(addonName) {
            if (!installedAddons.includes(addonName)) {
                installedAddons.push(addonName);
                showSuccess(`${addonName} addon installed successfully!`);
                
                // Apply addons to all open tabs
                tabs.forEach(tab => {
                    if (tab.iframe) {
                        applyAddonsToIframe(tab.iframe);
                    }
                });
            } else {
                showSuccess(`${addonName} addon is already installed!`);
            }
        }
        
        function applyAddonsToIframe(iframe) {
            // This is a simplified version - in a real implementation,
            // this would inject JavaScript into the iframe to add functionality
            
            // For demonstration, we'll just log that addons would be applied
            console.log('Applying addons to iframe:', installedAddons);
        }
        
        // Utility functions
        function getSharedData() {
            const defaultData = {
                schools: {},
                teachers: {},
                parents: {},
                classes: {},
                students: {},
                parentCodes: {},
                bypassCodes: {},
                schedules: {},
                schoolSettings: {},
                activityLogs: {},
                lastUpdated: Date.now()
            };
            
            try {
                const stored = localStorage.getItem('classStacksData');
                if (stored) {
                    const parsed = JSON.parse(stored);
                    return {...defaultData, ...parsed};
                }
            } catch (e) {
                console.error('Error parsing stored data:', e);
            }
            
            return defaultData;
        }
        
        function saveSharedData(data) {
            try {
                data.lastUpdated = Date.now();
                localStorage.setItem('classStacksData', JSON.stringify(data));
                return true;
            } catch (e) {
                console.error('Error saving data:', e);
                return false;
            }
        }
        
        function extractDomain(url) {
            try {
                const domain = new URL(url).hostname;
                return domain.replace('www.', '');
            } catch (e) {
                const match = url.match(/(?:https?:\/\/)?(?:www\.)?([^\/]+)/i);
                return match ? match[1] : url;
            }
        }
        
        function getWebsiteName(domain) {
            const names = {
                'google.com': 'Google',
                'youtube.com': 'YouTube',
                'wikipedia.org': 'Wikipedia',
                'khanacademy.org': 'Khan Academy',
                'github.com': 'GitHub',
                'stackoverflow.com': 'Stack Overflow',
                'code.org': 'Code.org',
                'duolingo.com': 'Duolingo',
                'coursera.org': 'Coursera'
            };
            return names[domain] || domain;
        }
        
        function getWebsiteIcon(domain) {
            const icons = {
                'google.com': 'üîç',
                'youtube.com': 'üì∫',
                'wikipedia.org': 'üìö',
                'khanacademy.org': 'üéì',
                'github.com': 'üíª',
                'stackoverflow.com': 'üí°',
                'code.org': 'üë®‚Äçüíª',
                'duolingo.com': 'ü¶â',
                'coursera.org': 'üéì'
            };
            return icons[domain] || 'üåê';
        }
        
        function getWebsiteColor(domain) {
            const colors = {
                'google.com': '#4285f4',
                'youtube.com': '#ff0000',
                'wikipedia.org': '#000000',
                'khanacademy.org': '#14bf96',
                'github.com': '#24292e',
                'stackoverflow.com': '#f48024',
                'code.org': '#0fbd8c',
                'duolingo.com': '#58cc02',
                'coursera.org': '#2a73cc'
            };
            return colors[domain] || '#4361ee';
        }
        
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            if (/Mobile|Android|iPhone|iPad|iPod/.test(ua)) {
                return 'Mobile';
            } else if (/Tablet|iPad/.test(ua)) {
                return 'Tablet';
            } else {
                return 'Desktop';
            }
        }
        
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => errorElement.style.display = 'none', 5000);
        }
        
        function showSuccess(message) {
            // Create a temporary success message
            const successElement = document.createElement('div');
            successElement.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--success);
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                z-index: 1001;
                max-width: 400px;
                text-align: center;
            `;
            successElement.textContent = message;
            document.body.appendChild(successElement);
            
            setTimeout(() => {
                document.body.removeChild(successElement);
            }, 3000);
        }
        
        function logout() {
            if (currentStudent) {
                // Mark student as inactive
                const data = getSharedData();
                if (data.students[currentStudent.id]) {
                    data.students[currentStudent.id].active = false;
                    
                    // Log the disconnection
                    if (!data.activityLogs) data.activityLogs = {};
                    if (!data.activityLogs[studentId]) data.activityLogs[studentId] = [];
                    data.activityLogs[studentId].push({
                        action: 'Student disconnected',
                        timestamp: Date.now()
                    });
                    
                    saveSharedData(data);
                }
                
                // Stop monitoring and screenshots
                if (updateInterval) {
                    clearInterval(updateInterval);
                }
                if (screenshotInterval) {
                    clearInterval(screenshotInterval);
                }
            }
            
            localStorage.removeItem('currentStudent');
            document.getElementById('studentBrowser').style.display = 'none';
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('authForm').reset();
            currentStudent = null;
            studentId = null;
            currentSchoolCode = '';
            currentClassCode = '';
            tabs = [];
            activeTabIndex = 0;
            bypassActive = false;
            bypassExpiry = 0;
            installedAddons = [];
            connectionCode = '';
        }
    </script>
</body>
</html>

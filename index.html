<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Stacks - Student Browser</title>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --danger: #e63946;
            --success: #2a9d8f;
            --dark: #212529;
            --light: #f8f9fa;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f5f7fb;
            color: var(--dark);
        }
        
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        
        .auth-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo h1 {
            color: var(--primary);
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5ee;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        .btn {
            padding: 12px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: var(--secondary);
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .error-message {
            color: var(--danger);
            text-align: center;
            margin-top: 15px;
            padding: 12px;
            background: #ffeaea;
            border-radius: 8px;
            display: none;
        }
        
        .student-browser {
            display: none;
        }
        
        .student-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            z-index: 1000;
        }
        
        .browser-header {
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .browser-controls {
            display: flex;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            gap: 15px;
            align-items: center;
        }
        
        .url-input-container {
            flex: 1;
            display: flex;
            background: white;
            border: 2px solid #e1e5ee;
            border-radius: 25px;
            overflow: hidden;
        }
        
        .url-input {
            flex: 1;
            padding: 12px 20px;
            border: none;
            font-size: 16px;
        }
        
        .url-input:focus {
            outline: none;
        }
        
        .go-button {
            padding: 12px 25px;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
        }
        
        .browser-content {
            height: calc(100vh - 160px);
            background: white;
        }
        
        .website-list {
            padding: 30px;
        }
        
        .website-category {
            margin-bottom: 30px;
        }
        
        .website-category h3 {
            margin-bottom: 15px;
            color: var(--primary);
            font-size: 1.2rem;
        }
        
        .website-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .website-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .website-item:hover {
            background: white;
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .website-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .blocked-message, .locked-message {
            display: none;
            background: #ffebee;
            color: #c62828;
            padding: 40px;
            text-align: center;
            height: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .locked-message {
            background: #e9ecef;
            color: #6c757d;
        }
        
        .home-screen {
            padding: 40px;
            text-align: center;
        }
        
        .welcome-message {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 30px;
        }

        .loading-message {
            display: none;
            padding: 40px;
            text-align: center;
            font-size: 1.2rem;
            color: #666;
        }

        .message-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1001;
            display: none;
            max-width: 400px;
            text-align: center;
        }

        .message-content {
            margin: 10px 0;
            font-size: 1.1rem;
        }

        .message-from {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .url-examples {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        .url-examples h4 {
            margin-bottom: 10px;
            color: var(--primary);
        }

        .url-example {
            display: inline-block;
            background: white;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 5px;
            border: 1px solid #e1e5ee;
            cursor: pointer;
        }

        .url-example:hover {
            background: var(--primary);
            color: white;
        }

        .restriction-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        .teacher-control-notice {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        .screen-sharing-notice {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        .screen-sharing-status {
            background: var(--success);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            display: inline-block;
            margin: 10px 0;
        }

        .website-view {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: white;
        }

        .website-preview {
            text-align: center;
            padding: 40px;
            max-width: 600px;
        }

        .website-preview-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .website-preview-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .website-preview-url {
            font-family: monospace;
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 15px 0;
            word-break: break-all;
        }

        .website-preview-status {
            color: #666;
            font-size: 0.9rem;
            margin-top: 20px;
        }

        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 1000;
        }
        
        .new-tab-notice {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 20px;
            margin: 20px;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .browser-controls {
                flex-direction: column;
            }
            
            .url-input-container {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Student Authentication -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="logo">
                <h1>üéì Class Stacks</h1>
                <p>Student Browser</p>
            </div>
            
            <form id="authForm">
                <div class="form-group">
                    <label for="studentName">Your Name</label>
                    <input type="text" id="studentName" placeholder="Enter your name" required>
                </div>
                
                <div class="form-group">
                    <label for="classCode">Class Code</label>
                    <input type="text" id="classCode" placeholder="Enter class code from teacher" required>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                        Ask your teacher for the current class code
                    </div>
                </div>
                
                <button type="submit" class="btn" style="width: 100%;">Enter Browser</button>
            </form>
            
            <div class="error-message" id="errorMessage"></div>
            
            <div style="margin-top: 25px; padding: 20px; background: #f8f9fa; border-radius: 10px; font-size: 14px;">
                <strong>How to Connect:</strong><br>
                1. Ask your teacher for the current class code<br>
                2. Enter your name and the class code<br>
                3. Click "Enter Browser" to start
            </div>
            
            <div style="margin-top: 15px; padding: 15px; background: #e7f3ff; border-radius: 10px; font-size: 14px;">
                <strong>Demo Class Codes:</strong><br>
                ‚Ä¢ MATH101 (Mathematics Grade 5)<br>
                ‚Ä¢ SCI202 (Science Grade 6)<br>
                ‚Ä¢ ENG303 (English Grade 7)
            </div>
        </div>
    </div>

    <!-- Student Browser -->
    <div class="student-browser" id="studentBrowser">
        <div class="student-info">
            Student: <span id="studentNameDisplay">Unknown</span> | 
            Class: <span id="classCodeDisplay">Unknown</span>
            <button class="btn-danger" onclick="logout()" style="margin-left: 10px; padding: 5px 10px; font-size: 0.8rem;">Exit</button>
        </div>
        
        <div class="browser-header">
            <h2>üîí Class Stacks Secure Browser</h2>
            <p>Teacher Monitored ‚Ä¢ Educational Focus</p>
        </div>
        
        <div class="browser-controls">
            <div class="url-input-container">
                <input type="text" class="url-input" id="browserUrl" placeholder="Type any website URL and press Enter (e.g., google.com, youtube.com)">
                <button class="go-button" onclick="navigateToUrl()">Go</button>
            </div>
            <button class="btn" onclick="goHome()">üè† Home</button>
        </div>
        
        <div class="browser-content" id="browserContent">
            <div class="locked-message" id="lockedMessage">
                <div style="font-size: 4rem; margin-bottom: 20px;">üîí</div>
                <h2>Browser Locked</h2>
                <p>Your teacher has locked your browser.</p>
                <p>You cannot access any websites at this time.</p>
                <button class="btn" onclick="goHome()" style="margin-top: 20px;">Return to Home</button>
            </div>
            
            <div class="teacher-control-notice" id="teacherControlNotice" style="display: none;">
                <h4>üéÆ Teacher Navigation</h4>
                <p>Your teacher is navigating your browser to: <strong id="teacherControlUrl"></strong></p>
                <button class="btn" onclick="acceptTeacherControl()">Continue</button>
            </div>
            
            <div class="blocked-message" id="blockedMessage">
                <div style="font-size: 4rem; margin-bottom: 20px;">üö´</div>
                <h2>Website Blocked</h2>
                <p>This website has been restricted by your teacher.</p>
                <p id="blockedUrlText" style="font-family: monospace; margin: 10px 0; font-size: 1.1rem;"></p>
                <button class="btn" onclick="closeBlockedMessage()" style="margin-top: 20px;">Return to Safe Browsing</button>
            </div>
            
            <div class="loading-message" id="loadingMessage">
                <div style="font-size: 3rem; margin-bottom: 20px;">‚è≥</div>
                <h3>Loading Website...</h3>
                <p>Please wait while we load the website securely.</p>
            </div>

            <div class="website-view" id="websiteView" style="display: none;">
                <div class="website-preview">
                    <div class="website-preview-icon" id="currentWebsiteIcon">üåê</div>
                    <div class="website-preview-name" id="currentWebsiteName">Website</div>
                    <div class="website-preview-url" id="currentWebsiteUrl">https://example.com</div>
                    <div class="website-preview-status">
                        <p>üü¢ Currently Viewing</p>
                        <p>Your teacher can see this activity</p>
                    </div>
                </div>
            </div>

            <div class="new-tab-notice" id="newTabNotice" style="display: none;">
                <div style="font-size: 3rem; margin-bottom: 20px;">üåê</div>
                <h3>Website Opened in New Tab</h3>
                <p>This website doesn't allow embedding for security reasons.</p>
                <p>It has been opened in a new browser tab for you.</p>
                <p id="newTabUrl" style="margin: 15px 0; font-family: monospace;"></p>
                <button class="btn" onclick="goHome()" style="margin-top: 20px;">Return to Browser Home</button>
            </div>
            
            <div class="home-screen" id="homeScreen">
                <div class="welcome-message">
                    Welcome to Class Stacks Browser!<br>
                    <small style="font-size: 1rem; color: #666;">Type any website URL above or click on a website below.</small>
                </div>

                <div class="screen-sharing-notice">
                    <h4>üìπ Activity Monitoring Active</h4>
                    <p>Your teacher can view your browsing activity to help with your work.</p>
                    <p><small>Activity is updated every 2.5 seconds</small></p>
                </div>

                <div id="restrictionNotice" class="restriction-notice" style="display: none;">
                    <h4>üîí Restricted Mode Active</h4>
                    <p>Your teacher has enabled website restrictions. Some sites may be blocked for educational purposes.</p>
                </div>
                
                <div class="url-examples">
                    <h4>üí° Try these URLs:</h4>
                    <span class="url-example" onclick="visitWebsite('google.com')">google.com</span>
                    <span class="url-example" onclick="visitWebsite('youtube.com')">youtube.com</span>
                    <span class="url-example" onclick="visitWebsite('wikipedia.org')">wikipedia.org</span>
                    <span class="url-example" onclick="visitWebsite('khanacademy.org')">khanacademy.org</span>
                    <span class="url-example" onclick="visitWebsite('github.com')">github.com</span>
                    <span class="url-example" onclick="visitWebsite('stackoverflow.com')">stackoverflow.com</span>
                    <span class="url-example" onclick="visitWebsite('code.org')">code.org</span>
                    <span class="url-example" onclick="visitWebsite('duolingo.com')">duolingo.com</span>
                </div>
                
                <div class="website-list">
                    <div class="website-category">
                        <h3>üåê Educational Websites</h3>
                        <div class="website-grid">
                            <div class="website-item" onclick="visitWebsite('https://www.khanacademy.org')">
                                <div class="website-icon">üìö</div>
                                <div>Khan Academy</div>
                            </div>
                            <div class="website-item" onclick="visitWebsite('https://www.wikipedia.org')">
                                <div class="website-icon">üåê</div>
                                <div>Wikipedia</div>
                            </div>
                            <div class="website-item" onclick="visitWebsite('https://www.google.com')">
                                <div class="website-icon">üîç</div>
                                <div>Google Search</div>
                            </div>
                            <div class="website-item" onclick="visitWebsite('https://stackoverflow.com')">
                                <div class="website-icon">üí°</div>
                                <div>Stack Overflow</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="website-category">
                        <h3>üë®‚Äçüíª Coding Resources</h3>
                        <div class="website-grid">
                            <div class="website-item" onclick="visitWebsite('https://github.com')">
                                <div class="website-icon">üíª</div>
                                <div>GitHub</div>
                            </div>
                            <div class="website-item" onclick="visitWebsite('https://code.org')">
                                <div class="website-icon">üë®‚Äçüíª</div>
                                <div>Code.org</div>
                            </div>
                            <div class="website-item" onclick="visitWebsite('https://scratch.mit.edu')">
                                <div class="website-icon">üê±</div>
                                <div>Scratch</div>
                            </div>
                            <div class="website-item" onclick="visitWebsite('https://www.w3schools.com')">
                                <div class="website-icon">üåç</div>
                                <div>W3Schools</div>
                            </div>
                        </div>
                    </div>

                    <div class="website-category">
                        <h3>üéì Learning Platforms</h3>
                        <div class="website-grid">
                            <div class="website-item" onclick="visitWebsite('https://www.duolingo.com')">
                                <div class="website-icon">ü¶â</div>
                                <div>Duolingo</div>
                            </div>
                            <div class="website-item" onclick="visitWebsite('https://www.coursera.org')">
                                <div class="website-icon">üéì</div>
                                <div>Coursera</div>
                            </div>
                            <div class="website-item" onclick="visitWebsite('https://www.edx.org')">
                                <div class="website-icon">üìñ</div>
                                <div>edX</div>
                            </div>
                            <div class="website-item" onclick="visitWebsite('https://www.udemy.com')">
                                <div class="website-icon">üéØ</div>
                                <div>Udemy</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Notification -->
    <div class="message-notification" id="messageNotification">
        <h4>üì© New Message from Teacher</h4>
        <div class="message-content" id="messageContent"></div>
        <div class="message-from" id="messageFrom"></div>
        <button class="btn" onclick="closeMessage()" style="margin-top: 10px; padding: 8px 15px;">OK</button>
    </div>

    <div class="connection-status" id="connectionStatus">üîÑ Connected</div>

    <script>
        // Student browser JavaScript
        let currentStudent = null;
        let lastUpdateCheck = 0;
        let lastMessageCheck = 0;
        let studentId = null;
        let currentClassCode = '';
        let currentUrl = '';
        let updateInterval;
        let activityInterval;

        // Check for existing session on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedStudent = localStorage.getItem('currentStudent');
            if (savedStudent) {
                try {
                    currentStudent = JSON.parse(savedStudent);
                    studentId = currentStudent.id;
                    currentClassCode = currentStudent.classCode;
                    
                    // Verify the class still exists in shared data
                    const data = getSharedData();
                    if (data.students && data.students[studentId]) {
                        showStudentBrowser();
                    } else {
                        // Session expired or invalid
                        localStorage.removeItem('currentStudent');
                        showError('Session expired. Please log in again.');
                    }
                } catch (e) {
                    localStorage.removeItem('currentStudent');
                    showError('Invalid session data. Please log in again.');
                }
            }
        });

        // Student authentication
        document.getElementById('authForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const studentName = document.getElementById('studentName').value.trim();
            const classCode = document.getElementById('classCode').value.trim().toUpperCase();
            
            if (!studentName) {
                showError('Please enter your name');
                return;
            }
            
            if (!classCode) {
                showError('Please enter a class code');
                return;
            }

            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Connecting...';
            submitBtn.disabled = true;

            // Check if class code exists in shared data
            setTimeout(() => {
                const data = getSharedData();
                
                // Check if class exists in classes
                const classExists = data.classes && data.classes[classCode];
                
                if (classExists) {
                    // Class code is valid - create student session
                    studentId = 'student_' + btoa(studentName + classCode).replace(/[^a-zA-Z0-9]/g, '');
                    currentClassCode = classCode;
                    
                    currentStudent = {
                        id: studentId,
                        name: studentName,
                        classCode: classCode,
                        lastActive: Date.now(),
                        currentUrl: '',
                        currentActivity: 'Logged in to browser',
                        device: getDeviceInfo(),
                        connected: true
                    };
                    
                    // Register student with teacher dashboard
                    registerStudent();
                    
                    // Save student data
                    localStorage.setItem('currentStudent', JSON.stringify(currentStudent));
                    showStudentBrowser();
                } else {
                    // Class code doesn't exist
                    showError(`Class code "${classCode}" not found. Please check with your teacher.`);
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            }, 1000);
        });
        
        // Register student with teacher dashboard
        function registerStudent() {
            const data = getSharedData();
            if (!data.students) data.students = {};
            data.students[currentStudent.id] = currentStudent;
            
            // Ensure the class exists in classes object
            if (!data.classes) data.classes = {};
            if (!data.classes[currentClassCode]) {
                data.classes[currentClassCode] = {
                    name: `Class ${currentClassCode}`,
                    created: Date.now(),
                    autoCreated: true
                };
            }
            
            // Log the connection
            if (!data.activityLogs) data.activityLogs = {};
            if (!data.activityLogs[studentId]) data.activityLogs[studentId] = [];
            data.activityLogs[studentId].push({
                action: 'Student connected to class',
                timestamp: Date.now()
            });
            
            saveSharedData(data);
        }
        
        // Get shared data from localStorage
        function getSharedData() {
            const defaultData = {
                students: {},
                classes: {},
                blockedSites: [
                    'youtube.com', 'facebook.com', 'tiktok.com', 'instagram.com', 
                    'netflix.com', 'twitter.com', 'snapchat.com', 'reddit.com', 
                    'twitch.tv', 'porn', 'xxx', 'adult', 'gambling'
                ],
                classSettings: {},
                teacherControl: {},
                messages: {},
                studentLocks: {},
                activityLogs: {},
                lastUpdated: Date.now()
            };
            
            try {
                const stored = localStorage.getItem('classStacksData');
                if (stored) {
                    const parsed = JSON.parse(stored);
                    // Merge with default data to ensure all properties exist
                    return {...defaultData, ...parsed};
                }
            } catch (e) {
                console.error('Error parsing stored data:', e);
            }
            
            // Return default data if nothing exists or error occurs
            return defaultData;
        }
        
        // Save shared data to localStorage
        function saveSharedData(data) {
            try {
                data.lastUpdated = Date.now();
                localStorage.setItem('classStacksData', JSON.stringify(data));
                return true;
            } catch (e) {
                console.error('Error saving data:', e);
                return false;
            }
        }
        
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => errorElement.style.display = 'none', 5000);
        }
        
        function showStudentBrowser() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('studentBrowser').style.display = 'block';
            document.getElementById('studentNameDisplay').textContent = currentStudent.name;
            document.getElementById('classCodeDisplay').textContent = currentStudent.classCode;
            
            // Check restriction status
            checkRestrictionStatus();
            
            // Start activity reporting
            startActivityReporting();
            
            // Start monitoring for teacher commands
            startMonitoring();
        }
        
        function startActivityReporting() {
            // Report activity every 2.5 seconds
            activityInterval = setInterval(() => {
                reportStudentActivity();
            }, 2500);
        }
        
        function reportStudentActivity() {
            if (!currentStudent) return;
            
            currentStudent.lastActive = Date.now();
            currentStudent.currentUrl = currentUrl;
            
            // Update in shared data
            const data = getSharedData();
            if (!data.students) data.students = {};
            data.students[currentStudent.id] = currentStudent;
            const success = saveSharedData(data);
            
            // Update connection status
            const statusElement = document.getElementById('connectionStatus');
            if (success) {
                statusElement.style.background = 'var(--success)';
                statusElement.textContent = 'üîÑ Connected';
            } else {
                statusElement.style.background = 'var(--warning)';
                statusElement.textContent = '‚ö†Ô∏è Connection Issues';
            }
            
            localStorage.setItem('currentStudent', JSON.stringify(currentStudent));
        }
        
        function startMonitoring() {
            updateInterval = setInterval(() => {
                checkRestrictionStatus();
                checkForMessages();
                checkForTeacherControl();
                reportStudentActivity();
                
                // Check for teacher updates
                const data = getSharedData();
                if (data.lastUpdated && data.lastUpdated > lastUpdateCheck) {
                    lastUpdateCheck = data.lastUpdated;
                    checkRestrictionStatus();
                    checkForTeacherControl();
                }
            }, 2000);
        }
        
        function visitWebsite(url) {
            document.getElementById('browserUrl').value = url;
            navigateToUrl();
        }
        
        function navigateToUrl() {
            // Check if browser is locked
            const data = getSharedData();
            const classSettings = data.classSettings && data.classSettings[currentClassCode] ? data.classSettings[currentClassCode] : { allowBrowsing: true };
            const studentLocked = data.studentLocks && data.studentLocks[studentId];
            
            if (classSettings.allowBrowsing === false || studentLocked) {
                showLockedMessage();
                return;
            }
            
            const urlInput = document.getElementById('browserUrl');
            let url = urlInput.value.trim();
            
            if (!url) return;

            // Add protocol if missing
            let fullUrl = url;
            if (!url.startsWith('http')) {
                fullUrl = 'https://' + url;
            }

            // Extract domain for blocking check
            const domain = extractDomain(fullUrl);
            
            // Check if website is blocked (always check if blocking is enabled for class)
            const blockingEnabled = classSettings.blockingEnabled !== false; // Default to true
            if (blockingEnabled && isUrlBlocked(domain)) {
                showBlockedMessage(domain);
                return;
            }
            
            // Show loading message
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('homeScreen').style.display = 'none';
            document.getElementById('blockedMessage').style.display = 'none';
            document.getElementById('lockedMessage').style.display = 'none';
            document.getElementById('websiteView').style.display = 'none';
            document.getElementById('teacherControlNotice').style.display = 'none';
            document.getElementById('newTabNotice').style.display = 'none';
            
            // Log the website visit
            const sharedData = getSharedData();
            if (!sharedData.activityLogs) sharedData.activityLogs = {};
            if (!sharedData.activityLogs[studentId]) sharedData.activityLogs[studentId] = [];
            sharedData.activityLogs[studentId].push({
                action: `Visited ${getWebsiteName(domain)} (${fullUrl})`,
                timestamp: Date.now()
            });
            saveSharedData(sharedData);
            
            // Update current activity
            currentStudent.currentActivity = `Browsing: ${getWebsiteName(domain)}`;
            currentStudent.currentUrl = fullUrl;
            
            // Check if website allows embedding (common sites that block embedding)
            const sitesThatBlockEmbedding = [
                'google.com', 'youtube.com', 'facebook.com', 'instagram.com',
                'twitter.com', 'linkedin.com', 'netflix.com', 'spotify.com'
            ];
            
            const blocksEmbedding = sitesThatBlockEmbedding.some(site => 
                domain.includes(site)
            );
            
            if (blocksEmbedding) {
                // Open in new tab and show notice
                setTimeout(() => {
                    document.getElementById('loadingMessage').style.display = 'none';
                    document.getElementById('newTabNotice').style.display = 'block';
                    document.getElementById('newTabUrl').textContent = fullUrl;
                    
                    // Open website in new tab
                    window.open(fullUrl, '_blank');
                }, 1000);
            } else {
                // Show website preview (simulated)
                setTimeout(() => {
                    document.getElementById('loadingMessage').style.display = 'none';
                    document.getElementById('websiteView').style.display = 'flex';
                    
                    const domainName = extractDomain(fullUrl);
                    document.getElementById('currentWebsiteUrl').textContent = fullUrl;
                    document.getElementById('currentWebsiteName').textContent = getWebsiteName(domainName);
                    document.getElementById('currentWebsiteIcon').textContent = getWebsiteIcon(domainName);
                    
                    // Update student activity
                    currentStudent.currentUrl = fullUrl;
                    updateStudentInSharedData();
                }, 1500);
            }
        }

        function showLockedMessage() {
            document.getElementById('lockedMessage').style.display = 'flex';
            document.getElementById('homeScreen').style.display = 'none';
            document.getElementById('blockedMessage').style.display = 'none';
            document.getElementById('websiteView').style.display = 'none';
            document.getElementById('newTabNotice').style.display = 'none';
            
            currentUrl = '';
            currentStudent.currentUrl = '';
            currentStudent.currentActivity = 'Browser locked by teacher';
            updateStudentInSharedData();
        }

        function extractDomain(url) {
            try {
                const domain = new URL(url).hostname;
                return domain.replace('www.', '');
            } catch (e) {
                const match = url.match(/(?:https?:\/\/)?(?:www\.)?([^\/]+)/i);
                return match ? match[1] : url;
            }
        }
        
        function isUrlBlocked(domain) {
            const data = getSharedData();
            const blockedSites = data.blockedSites || [];
            
            // Check if domain contains any blocked site
            return blockedSites.some(site => {
                // Check for exact domain match or partial match
                return domain.toLowerCase().includes(site.toLowerCase()) || 
                       site.toLowerCase().includes(domain.toLowerCase());
            });
        }
        
        function showBlockedMessage(url) {
            document.getElementById('blockedMessage').style.display = 'flex';
            document.getElementById('homeScreen').style.display = 'none';
            document.getElementById('lockedMessage').style.display = 'none';
            document.getElementById('websiteView').style.display = 'none';
            document.getElementById('newTabNotice').style.display = 'none';
            document.getElementById('blockedUrlText').textContent = url;
            
            currentUrl = 'BLOCKED: ' + url;
            currentStudent.currentUrl = currentUrl;
            currentStudent.currentActivity = 'Attempted to visit blocked site';
            updateStudentInSharedData();
        }
        
        function closeBlockedMessage() {
            document.getElementById('blockedMessage').style.display = 'none';
            document.getElementById('homeScreen').style.display = 'block';
            document.getElementById('browserUrl').value = '';
            
            currentUrl = '';
            currentStudent.currentUrl = '';
            currentStudent.currentActivity = 'Browsing home screen';
            updateStudentInSharedData();
        }
        
        function goHome() {
            document.getElementById('websiteView').style.display = 'none';
            document.getElementById('blockedMessage').style.display = 'none';
            document.getElementById('lockedMessage').style.display = 'none';
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('teacherControlNotice').style.display = 'none';
            document.getElementById('newTabNotice').style.display = 'none';
            document.getElementById('homeScreen').style.display = 'block';
            document.getElementById('browserUrl').value = '';
            
            currentUrl = '';
            currentStudent.currentUrl = '';
            currentStudent.currentActivity = 'Browsing home screen';
            updateStudentInSharedData();
        }
        
        function logout() {
            if (currentStudent) {
                // Mark student as inactive in shared data
                const data = getSharedData();
                if (data.students[currentStudent.id]) {
                    data.students[currentStudent.id].active = false;
                    
                    // Log the disconnection
                    if (!data.activityLogs) data.activityLogs = {};
                    if (!data.activityLogs[studentId]) data.activityLogs[studentId] = [];
                    data.activityLogs[studentId].push({
                        action: 'Student disconnected',
                        timestamp: Date.now()
                    });
                    
                    saveSharedData(data);
                }
                
                // Stop monitoring and activity reporting
                if (updateInterval) {
                    clearInterval(updateInterval);
                }
                if (activityInterval) {
                    clearInterval(activityInterval);
                }
            }
            
            localStorage.removeItem('currentStudent');
            document.getElementById('studentBrowser').style.display = 'none';
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('authForm').reset();
            currentStudent = null;
            studentId = null;
            currentClassCode = '';
            currentUrl = '';
        }
        
        // Handle Enter key in URL input
        document.getElementById('browserUrl').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                navigateToUrl();
            }
        });

        // Check for restriction updates
        function checkRestrictionStatus() {
            const data = getSharedData();
            const classSettings = data.classSettings && data.classSettings[currentClassCode] ? data.classSettings[currentClassCode] : { allowBrowsing: true, blockingEnabled: true };
            const studentLocked = data.studentLocks && data.studentLocks[studentId];
            
            // Show/hide restriction notice
            const notice = document.getElementById('restrictionNotice');
            if (classSettings.blockingEnabled) {
                notice.style.display = 'block';
            } else {
                notice.style.display = 'none';
            }
            
            // Show locked message if browser is locked
            if (classSettings.allowBrowsing === false || studentLocked) {
                if (document.getElementById('homeScreen').style.display !== 'block') {
                    showLockedMessage();
                }
            }
        }

        // Check for teacher control commands
        function checkForTeacherControl() {
            if (!studentId) return;

            const data = getSharedData();
            const teacherControl = data.teacherControl || {};
            const controlCommand = teacherControl[studentId];
            
            if (controlCommand && controlCommand.timestamp > lastUpdateCheck) {
                if (controlCommand.action === 'closeTab') {
                    // Close current tab and go home
                    goHome();
                    alert('Your teacher closed your current tab');
                    
                    // Log the action
                    if (!data.activityLogs) data.activityLogs = {};
                    if (!data.activityLogs[studentId]) data.activityLogs[studentId] = [];
                    data.activityLogs[studentId].push({
                        action: 'Teacher closed tab',
                        timestamp: Date.now()
                    });
                    saveSharedData(data);
                    
                    // Clear the control command
                    delete teacherControl[studentId];
                    data.teacherControl = teacherControl;
                    saveSharedData(data);
                } else if (controlCommand.url) {
                    // Show teacher control notice
                    document.getElementById('teacherControlUrl').textContent = controlCommand.url;
                    document.getElementById('teacherControlNotice').style.display = 'block';
                    document.getElementById('homeScreen').style.display = 'none';
                    document.getElementById('websiteView').style.display = 'none';
                    document.getElementById('newTabNotice').style.display = 'none';
                    
                    lastUpdateCheck = controlCommand.timestamp;
                }
            }
        }

        // Accept teacher control and navigate to the specified URL
        function acceptTeacherControl() {
            const data = getSharedData();
            const teacherControl = data.teacherControl || {};
            const controlCommand = teacherControl[studentId];
            
            if (controlCommand) {
                document.getElementById('browserUrl').value = controlCommand.url;
                navigateToUrl();
                
                // Log the teacher navigation
                if (!data.activityLogs) data.activityLogs = {};
                if (!data.activityLogs[studentId]) data.activityLogs[studentId] = [];
                data.activityLogs[studentId].push({
                    action: `Teacher navigated to ${controlCommand.url}`,
                    timestamp: Date.now()
                });
                
                // Clear the control command
                delete teacherControl[studentId];
                data.teacherControl = teacherControl;
                saveSharedData(data);
                
                document.getElementById('teacherControlNotice').style.display = 'none';
            }
        }

        // Check for new messages from teacher
        function checkForMessages() {
            if (!studentId) return;

            const data = getSharedData();
            const messages = data.messages || {};
            const studentMessages = messages[studentId];
            
            if (studentMessages && studentMessages.length > 0) {
                const latestMessage = studentMessages[studentMessages.length - 1];
                
                // Only show if it's a new message
                if (latestMessage.timestamp > lastMessageCheck) {
                    lastMessageCheck = latestMessage.timestamp;
                    showMessage(latestMessage.text, latestMessage.from);
                }
            }
        }

        function showMessage(message, from) {
            document.getElementById('messageContent').textContent = message;
            document.getElementById('messageFrom').textContent = `From: ${from}`;
            document.getElementById('messageNotification').style.display = 'block';
        }

        function closeMessage() {
            document.getElementById('messageNotification').style.display = 'none';
        }

        // Update student in shared data
        function updateStudentInSharedData() {
            const data = getSharedData();
            data.students[currentStudent.id] = currentStudent;
            saveSharedData(data);
        }

        // Get device info
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            if (/Mobile|Android|iPhone|iPad|iPod/.test(ua)) {
                return 'Mobile';
            } else if (/Tablet|iPad/.test(ua)) {
                return 'Tablet';
            } else {
                return 'Desktop';
            }
        }

        // Get website name from domain
        function getWebsiteName(domain) {
            const names = {
                'google.com': 'Google',
                'youtube.com': 'YouTube',
                'wikipedia.org': 'Wikipedia',
                'khanacademy.org': 'Khan Academy',
                'github.com': 'GitHub',
                'facebook.com': 'Facebook',
                'twitter.com': 'Twitter',
                'instagram.com': 'Instagram',
                'tiktok.com': 'TikTok',
                'netflix.com': 'Netflix',
                'chat.openai.com': 'ChatGPT',
                'stackoverflow.com': 'Stack Overflow',
                'code.org': 'Code.org',
                'scratch.mit.edu': 'Scratch',
                'w3schools.com': 'W3Schools',
                'duolingo.com': 'Duolingo',
                'coursera.org': 'Coursera',
                'edx.org': 'edX',
                'udemy.com': 'Udemy'
            };
            return names[domain] || domain;
        }

        // Get website icon from domain
        function getWebsiteIcon(domain) {
            const icons = {
                'google.com': 'üîç',
                'youtube.com': 'üì∫',
                'wikipedia.org': 'üìö',
                'khanacademy.org': 'üéì',
                'github.com': 'üíª',
                'facebook.com': 'üë•',
                'twitter.com': 'üê¶',
                'instagram.com': 'üì∑',
                'tiktok.com': 'üéµ',
                'netflix.com': 'üé¨',
                'chat.openai.com': 'ü§ñ',
                'stackoverflow.com': 'üí°',
                'code.org': 'üë®‚Äçüíª',
                'scratch.mit.edu': 'üê±',
                'w3schools.com': 'üåç',
                'duolingo.com': 'ü¶â',
                'coursera.org': 'üéì',
                'edx.org': 'üìñ',
                'udemy.com': 'üéØ'
            };
            return icons[domain] || 'üåê';
        }

        // Initialize
        goHome();
    </script>
</body>
</html>
